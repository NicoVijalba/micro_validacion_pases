services:
  migrate:
    image: migrate/migrate:v4.17.1
    restart: "no"
    env_file:
      - .env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./migrations:/migrations:ro
    command: ["-path=/migrations", "-database", "${MIGRATE_DATABASE_URL:?MIGRATE_DATABASE_URL is required}", "up"]
    networks:
      - backend

  app:
    image: ${IMAGE:-ghcr.io/nicovijalba/micro_validacion_pases:latest}
    container_name: micro_validacion_pases
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      migrate:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    read_only: true
    cap_drop: ["ALL"]
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/healthz"]
      interval: 15s
      timeout: 3s
      retries: 6
    networks:
      - backend

networks:
  backend:
    driver: bridge
